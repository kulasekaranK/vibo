"use strict";(self.webpackChunkapp=self.webpackChunkapp||[]).push([[510],{510:(I,E,m)=>{m.r(E),m.d(E,{ChatPage:()=>s});var u=m(467),g=m(177),h=m(4341),e=m(2220),v=m(5891),r=m(4438),U=m(8287),A=m(9152),y=m(6766);function M(t,n){1&t&&(r.j41(0,"span",7),r.EFF(1,"\nnotifications\n"),r.k0s())}function O(t,n){if(1&t){const a=r.RV6();r.j41(0,"ion-item",3),r.bIt("click",function(){const i=r.eBV(a).$implicit,c=r.XpG();return r.Njj(c.openChat(i.receiverId,i.chatId))}),r.j41(1,"ion-avatar",4),r.nrm(2,"img",5),r.k0s(),r.j41(3,"ion-label")(4,"h2"),r.EFF(5),r.k0s(),r.j41(6,"p"),r.EFF(7),r.k0s()(),r.DNE(8,M,2,0,"span",6),r.k0s()}if(2&t){const a=n.$implicit;r.R7$(2),r.Y8G("src",a.receiverAvatar,r.B4B),r.R7$(3),r.JRh(a.receiverName),r.R7$(2),r.JRh(a.text),r.R7$(),r.Y8G("ngIf",a.newMessages)}}let s=(()=>{var t;class n{constructor(o,i,c){this.firebaseService=o,this.database=i,this.router=c,this.currentUserId="",this.chatList=[],this.filteredChatList=[],this.searchQuery=""}ngOnInit(){var o=this;return(0,u.A)(function*(){const i=yield o.firebaseService.getCurrentUser();i&&(o.currentUserDetails=yield o.firebaseService.loadUserDetail(i.uid),o.currentUserId=i.uid,o.loadChatList(o.currentUserId))})()}loadChatList(o){var i=this;return(0,u.A)(function*(){const c=(0,v.KR)(i.database,"chats");(0,v.Zy)(c,function(){var l=(0,u.A)(function*(d){const f=d.val(),_={};if(i.chatList=[],f)for(const P in f){const D=f[P];if(D.messages){const p=Object.values(D.messages).pop(),C=p.senderId===o?p.receiverId:p.senderId,S=yield i.firebaseService.loadUserDetail(C),b=p.receiverId===o&&!p.read;_[C]?(_[C].text=p.text,_[C].timestamp=p.timestamp,_[C].newMessages=_[C].newMessages||b):_[C]={chatId:P,receiverName:S.name,receiverId:C,receiverAvatar:S.profilePic,text:p.text,timestamp:p.timestamp,newMessages:b}}}i.chatList=Object.values(_),i.filteredChatList=i.chatList});return function(d){return l.apply(this,arguments)}}())})()}openChat(o,i){this.updateReadStatus(i),this.router.navigate(["/conversation",o])}updateReadStatus(o){var i=this;return(0,u.A)(function*(){const c=(0,v.KR)(i.database,`chats/${o}/messages`);(0,v.Zy)(c,function(){var l=(0,u.A)(function*(d){const f=d.val();if(f){const _=Object.keys(f),P=_[_.length-1];f[P].read||(yield(0,v.yo)((0,v.KR)(i.database,`chats/${o}/messages/${P}`),{read:!0}))}});return function(d){return l.apply(this,arguments)}}())})()}filterChats(){this.filteredChatList=this.chatList.filter(o=>o.receiverName.toLowerCase().includes(this.searchQuery.toLowerCase()))}}return(t=n).\u0275fac=function(o){return new(o||t)(r.rXU(U.f),r.rXU(A.Wm),r.rXU(y.Ix))},t.\u0275cmp=r.VBU({type:t,selectors:[["app-chat"]],standalone:!0,features:[r.aNF],decls:10,vars:2,consts:[[1,"ion-no-border"],["placeholder","Search by name","animated","true",3,"ngModelChange","ionInput","ngModel"],["lines","none","class","ion-margin-top",3,"click",4,"ngFor","ngForOf"],["lines","none",1,"ion-margin-top",3,"click"],["slot","start"],["alt","avatar",3,"src"],["class","material-symbols-outlined","slot","end",4,"ngIf"],["slot","end",1,"material-symbols-outlined"]],template:function(o,i){1&o&&(r.j41(0,"ion-header",0)(1,"ion-toolbar")(2,"ion-buttons"),r.nrm(3,"ion-back-button"),r.k0s(),r.j41(4,"ion-title"),r.EFF(5,"Chats"),r.k0s()()(),r.j41(6,"ion-content")(7,"ion-searchbar",1),r.mxI("ngModelChange",function(l){return r.DH7(i.searchQuery,l)||(i.searchQuery=l),l}),r.bIt("ionInput",function(){return i.filterChats()}),r.k0s(),r.j41(8,"ion-list"),r.DNE(9,O,9,4,"ion-item",2),r.k0s()()),2&o&&(r.R7$(7),r.R50("ngModel",i.searchQuery),r.R7$(2),r.Y8G("ngForOf",i.filteredChatList))},dependencies:[e.he,e.mC,e.uz,e.nf,e.el,e.QW,e.W9,e.eU,e.BC,e.ai,e.S1,g.MD,g.Sq,g.bT,h.YN,h.BC,h.vS],styles:["ion-avatar[_ngcontent-%COMP%]{width:60px;height:60px}"]}),n})()},8287:(I,E,m)=>{m.d(E,{f:()=>A});var u=m(467),g=m(4665),h=m(9967),e=m(3273),v=m(4412),r=m(4438),U=m(6766);let A=(()=>{var y;class M{constructor(s,t,n){this.auth=s,this.firestore=t,this.router=n,this.postsSubject=new v.t([]),this.posts$=this.postsSubject.asObservable(),this.commentsSubject=new v.t([]),this.comments$=this.commentsSubject.asObservable(),this.getCurrentUser()}createUser(s,t){return(0,g.eJ)(this.auth,s,t)}loginUser(s,t){return(0,g.x9)(this.auth,s,t)}storeUserDetails(s,t,n,a){var o=this;return(0,u.A)(function*(){const i=(0,h.rJ)(o.firestore,"users");return yield(0,h.gS)(i,{name:s,phoneNumber:t,email:n,uid:a,followersCount:0,followingCount:0,userName:s,profilePic:"https://media.istockphoto.com/id/1397556857/vector/avatar-13.jpg?s=612x612&w=0&k=20&c=n4kOY_OEVVIMkiCNOnFbCxM0yQBiKVea-ylQG62JErI="})})()}getCurrentUser(){return new Promise(s=>{(0,g.hg)(this.auth,t=>{t&&localStorage.setItem("user",JSON.stringify(t)),s(t)})})}loadUserDetail(s){var t=this;return(0,u.A)(function*(){try{const n=(0,h.rJ)(t.firestore,"users"),a=(0,e.P)(n,(0,e._M)("uid","==",s)),i=(yield(0,e.GG)(a)).docs.map(c=>c.data());return i.length>0?i[0]:null}catch(n){return console.error("Error loading user details:",n),null}})()}loadPost(){var s=this;return(0,u.A)(function*(){try{const t=(0,h.rJ)(s.firestore,"posts");(0,e.aQ)(t,function(){var n=(0,u.A)(function*(a){const o=yield Promise.all(a.docs.map(function(){var i=(0,u.A)(function*(c){const l=c.data(),d=yield s.loadUserDetail(l.uid);return{id:c.id,...l,...d}});return function(c){return i.apply(this,arguments)}}()));o.sort((i,c)=>{var l,d;const f=(null===(l=i.createdAt)||void 0===l?void 0:l.toMillis())||0;return((null===(d=c.createdAt)||void 0===d?void 0:d.toMillis())||0)-f}),s.postsSubject.next(o)});return function(a){return n.apply(this,arguments)}}())}catch(t){console.error("Error loading posts:",t)}})()}postComment(s,t,n){var a=this;return(0,u.A)(function*(){const o=(0,h.rJ)(a.firestore,"comments");return yield(0,h.gS)(o,{uid:s,postId:t,comment:n})})()}loadComments(s){var t=this;return(0,u.A)(function*(){try{const n=(0,h.rJ)(t.firestore,"comments"),a=(0,e.P)(n,(0,e._M)("postId","==",s));(0,e.aQ)(a,function(){var o=(0,u.A)(function*(i){const c=yield Promise.all(i.docs.map(function(){var l=(0,u.A)(function*(d){const f=d.data(),_=yield t.loadUserDetail(f.uid);return{...f,..._}});return function(d){return l.apply(this,arguments)}}()));t.commentsSubject.next(c)});return function(i){return o.apply(this,arguments)}}())}catch(n){console.error("Error loading comments:",n)}})()}loadSavedPost(s){var t=this;return(0,u.A)(function*(){const n=(0,h.rJ)(t.firestore,"savedPosts"),a=(0,e.P)(n,(0,e._M)("uid","==",s)),o=yield(0,e.GG)(a);return(yield Promise.all(o.docs.map(function(){var c=(0,u.A)(function*(l){const f=l.data().postId,_=(0,e.H9)(t.firestore,`posts/${f}`),P=yield(0,e.x7)(_);if(P.exists()){const D=P.data(),R=D.uid,p=yield t.loadUserDetail(R);return{...D,...p}}return console.log(`Post with ID ${f} does not exist.`),null});return function(l){return c.apply(this,arguments)}}()))).filter(c=>null!==c)})()}toggleLikePost(s,t){var n=this;return(0,u.A)(function*(){const a=(0,e.H9)(n.firestore,"posts",s);yield(0,h.c4)(n.firestore,function(){var o=(0,u.A)(function*(i){const c=yield i.get(a);if(c.exists()){const l=c.data(),d=l.likedBy||[],f=d.includes(t)?-1:1;i.update(a,{likes:(0,e.GV)(f),likedBy:d.includes(t)?(0,e.C3)(t):(0,e.hq)(t)}),n.updatePostInState(s,{likes:l.likes+f,likedBy:d.includes(t)?d.filter(_=>_!==t):[...d,t]})}else console.log("Post does not exist.")});return function(i){return o.apply(this,arguments)}}())})()}updatePostInState(s,t){const a=this.postsSubject.getValue().map(o=>o.id===s?{...o,...t}:o);this.postsSubject.next(a)}getPostLikes(s){var t=this;return(0,u.A)(function*(){var n;const a=(0,e.H9)(t.firestore,"posts",s);return(null===(n=(yield(0,e.x7)(a)).data())||void 0===n?void 0:n.likes)||0})()}userLikeThisPost(s){var t=this;return(0,u.A)(function*(){const n=yield t.getCurrentUser();if(n){const a=(0,e.H9)(t.firestore,"posts",s),o=yield(0,e.x7)(a);if(o.exists())return(o.data().likedBy||[]).includes(n.uid)}return!1})()}loadSeparateUsersPost(s){var t=this;return(0,u.A)(function*(){try{const n=(0,h.rJ)(t.firestore,"posts"),a=(0,e.P)(n,(0,e._M)("uid","==",s)),o=yield(0,e.GG)(a);return yield Promise.all(o.docs.map(function(){var c=(0,u.A)(function*(l){const d=l.data(),f=d.uid,_=yield t.loadUserDetail(f);return{id:l.id,...d,..._}});return function(l){return c.apply(this,arguments)}}()))}catch(n){return console.error("Error loading posts:",n),null}})()}logout(){return localStorage.removeItem("user"),this.router.navigate(["/login"],{replaceUrl:!0}),this.auth.signOut()}savePost(s,t){var n=this;return(0,u.A)(function*(){const a=(0,h.rJ)(n.firestore,"savedPosts");return yield(0,h.gS)(a,{uid:s,postId:t})})()}StoreNotification(s){var t=this;return(0,u.A)(function*(){try{const n=(0,h.rJ)(t.firestore,"Notifications");yield(0,h.gS)(n,{title:s.title,message:s.body,timestamp:s.timestamp}),console.log("Notification stored successfully")}catch(n){console.error("Error storing notification: ",n)}})()}followUser(s){var t=this;return(0,u.A)(function*(){const n=yield t.getCurrentUser();if(!n)return void console.error("No current user found.");const a=yield t.isFollowing(s),o=(0,h.rJ)(t.firestore,"users"),i=(0,e.P)(o,(0,e._M)("uid","==",s)),c=yield(0,e.GG)(i);if(!c.empty){const l=c.docs[0];if(a){yield(0,e.mZ)(l.ref,{followersCount:(0,e.GV)(-1),followers:(0,e.C3)(n.uid)});const d=(0,e.P)(o,(0,e._M)("uid","==",n.uid)),f=yield(0,e.GG)(d);if(!f.empty){const _=f.docs[0];yield(0,e.mZ)(_.ref,{followingCount:(0,e.GV)(-1),following:(0,e.C3)(s)}),console.log("Successfully unfollowed the user.")}}else{yield(0,e.mZ)(l.ref,{followersCount:(0,e.GV)(1),followers:(0,e.hq)(n.uid)});const d=(0,e.P)(o,(0,e._M)("uid","==",n.uid)),f=yield(0,e.GG)(d);if(!f.empty){const _=f.docs[0];yield(0,e.mZ)(_.ref,{followingCount:(0,e.GV)(1),following:(0,e.hq)(s)}),console.log("Successfully followed the user.")}}}})()}isFollowing(s){var t=this;return(0,u.A)(function*(){const n=yield t.getCurrentUser();if(!n||!n.uid)return!1;const a=yield(0,e.GG)((0,e.P)((0,h.rJ)(t.firestore,"users"),(0,e._M)("uid","==",n.uid)));return a.empty?(console.error("Current user document not found."),!1):(a.docs[0].data().following||[]).includes(s)})()}sendResetLink(s){var t=this;return(0,u.A)(function*(){console.log(s);try{yield(0,g.J1)(t.auth,s),console.log("Password reset email sent!")}catch(n){console.error("Error sending password reset email:",n)}})()}sendVerificationEmail(s){return(0,g.gA)(s)}isEmailVerified(s){return s.emailVerified}reloadUser(s){return s.reload()}}return(y=M).\u0275fac=function(s){return new(s||y)(r.KVO(g.Nj),r.KVO(h._7),r.KVO(U.Ix))},y.\u0275prov=r.jDH({token:y,factory:y.\u0275fac,providedIn:"root"}),M})()}}]);